{% extends "core/home.html" %}

{% block title %}
    {{ post.title }}
{% endblock %}
{% load static %}
{% load user_tags %}
{% block scripts %}

    <!-- Аякс-скрипт проставления лайков-дизлайков к постам -->
    <script>
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Настройка AJAX
        $(function () {
            $.ajaxSetup({
                headers: {"X-CSRFToken": getCookie("csrftoken")}
            });
        });

        function like() {
            var like = $(this);
            var type = like.data('type');
            var pk = like.data('id');
            var action = like.data('action');
            var dislike = like.next();

            var l_id = 'l' + type + pk
            var d_id = 'd' + type + pk
            $('#' + l_id).toggleClass('text-success');
            $('#' + d_id).removeClass('text-danger');

            $.ajax({
                url: "/api/" + type + "/" + pk + "/" + action + "/",
                type: 'POST',
                data: {'obj': pk},

                success: function (json) {
                    like.find("[data-count='like']").text(json.like_count);
                    dislike.find("[data-count='dislike']").text(json.dislike_count);
                }
            });

            return false;

        }

        function dislike() {
            var dislike = $(this);
            var type = dislike.data('type');
            var pk = dislike.data('id');
            var action = dislike.data('action');
            var like = dislike.prev();

            var l_id = 'l' + type + pk
            var d_id = 'd' + type + pk
            $('#' + d_id).toggleClass('text-danger');
            $('#' + l_id).removeClass('text-success');

            $.ajax({
                url: "/api/" + type + "/" + pk + "/" + action + "/",
                type: 'POST',
                data: {'obj': pk},

                success: function (json) {
                    dislike.find("[data-count='dislike']").text(json.dislike_count);
                    like.find("[data-count='like']").text(json.like_count);
                }
            });

            return false;
        }

        // Подключение обработчиков
        $(function () {
            $('[data-action="like"]').click(like);
            $('[data-action="dislike"]').click(dislike);
        });
    </script>

{% endblock %}
{% block post %}

    <div class="card mb-4 mt-2" style="border-radius: 25px">
        <div class="card-header" style="border-radius: 25px">
            <h4 class="card-title mb-1">{{ post.title }}
                {% if post.author == user %}
                    <a href="{% url 'core:post_edit' post.slug post.id %}"
                       class="text-warning small text-right"><i class="fa fa-pencil" aria-hidden="true"></i></a>
                {% endif %}
            </h4>
            <small class="text-muted">
                <img src="{% static "img/ico/calendar_1.png" %}" height="21"
                     width="21"> {{ post.created|date:"SHORT_DATE_FORMAT" }} <img
                    src="{% static "img/ico/clock_1.png" %}" height="19" width="19"> {{ post.created|time:"H:i" }} <img
                    src="{% static "img/ico/user_1.png" %}" height="19" width="19"><a
                    href="{{ post.author.user_profile.get_absolute_url }}">{{ post.author }}</a>

            </small>
        </div>
        <div class="card-body">

            <p class="card-text">
                {{ post.body|safe }}
            </p>
        </div>
        <div class="card-footer d-inline-flex justify-content-between" style="cursor: pointer">
            <span class="text-muted"> Комментариев: {{ post.comments.count }} </span>

            <div>

                {% include 'core/include/like_dislike_panel.html' %}


                <span class="action-icons">
                    {% if user.is_authenticated %}
                        <a href="#addcomment" onclick="addComment('','')">
                            <i class="fa fa-reply"></i>
                        </a>
                    {% else %}
                        <a data-toggle="modal" data-target="#loginModal" style="cursor: pointer">
                            <i class="fa fa-reply"></i>
                        </a>
                    {% endif %}
                </span>
            </div>

        </div>

    </div>
{% endblock %}

{% block comments %}
    {% include 'core/include/comments.html' with object=post comments=post_comments %}
{% endblock %}

